<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Plus Fitness - An√°lise de Gargalos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            color: #764ba2;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .config-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            min-width: 300px;
        }
        
        .config-panel label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .config-panel input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stat-card h3 {
            color: #764ba2;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #999;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.3em;
            color: #764ba2;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .alerts-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .alert-item {
            padding: 15px;
            border-left: 4px solid #e74c3c;
            background: #fff5f5;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .alert-item.MEDIO {
            border-left-color: #f39c12;
            background: #fffbf0;
        }
        
        .alert-item.BAIXO {
            border-left-color: #3498db;
            background: #f0f8ff;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .alert-name {
            font-weight: 600;
            color: #333;
        }
        
        .alert-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .alert-badge.MEDIO {
            background: #f39c12;
        }
        
        .alert-badge.BAIXO {
            background: #3498db;
        }
        
        .alert-details {
            color: #666;
            font-size: 0.9em;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(118, 75, 162, 0.4);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #764ba2;
        }
        
        .error {
            background: #fff5f5;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .last-update {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>üèãÔ∏è Dashboard Plus Fitness</h1>
                <p class="subtitle">Sistema de An√°lise de Gargalos em Vendas</p>
            </div>
            <div class="config-panel">
                <label>üîë Supabase URL:</label>
                <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co">
                
                <label>üîê Supabase Key (anon):</label>
                <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                
                <button class="refresh-btn" onclick="saveConfig()">üíæ Salvar Config</button>
            </div>
        </header>
        
        <div id="errorContainer"></div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total de Conversas</h3>
                <div class="stat-value" id="totalConversas">-</div>
                <div class="stat-label">√∫ltimos 30 dias</div>
            </div>
            
            <div class="stat-card">
                <h3>Gargalos Detectados</h3>
                <div class="stat-value" id="totalGargalos">-</div>
                <div class="stat-label">requer aten√ß√£o</div>
            </div>
            
            <div class="stat-card">
                <h3>Taxa de Gargalos</h3>
                <div class="stat-value" id="taxaGargalos">-%</div>
                <div class="stat-label">m√©dia geral</div>
            </div>
            
            <div class="stat-card">
                <h3>Alertas Cr√≠ticos</h3>
                <div class="stat-value" id="alertasCriticos">-</div>
                <div class="stat-label">risco alto</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üìä Distribui√ß√£o de Gargalos por Tipo</div>
            <canvas id="gargalosChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üìà Evolu√ß√£o Di√°ria - √öltimos 14 Dias</div>
            <canvas id="evolucaoChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üë• Performance por Vendedor</div>
            <canvas id="vendedoresChart"></canvas>
        </div>
        
        <div class="alerts-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="chart-title" style="margin: 0;">üö® Leads Cr√≠ticos Pendentes</div>
                <button class="refresh-btn" id="refreshBtn" onclick="loadData()">üîÑ Atualizar</button>
            </div>
            <div id="alertsList"></div>
            <div class="last-update" id="lastUpdate"></div>
        </div>
    </div>
    
    <script>
        // Configura√ß√£o
        let supabaseUrl = localStorage.getItem('supabaseUrl') || '';
        let supabaseKey = localStorage.getItem('supabaseKey') || '';
        
        // Charts globais
        let gargalosChart, evolucaoChart, vendedoresChart;
        
        // Carregar configura√ß√£o salva
        window.addEventListener('load', () => {
            document.getElementById('supabaseUrl').value = supabaseUrl;
            document.getElementById('supabaseKey').value = supabaseKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
            
            if (supabaseUrl && supabaseKey) {
                loadData();
            }
        });
        
        function saveConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                showError('Por favor, preencha URL e Key do Supabase');
                return;
            }
            
            supabaseUrl = url;
            supabaseKey = key;
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            showError('‚úÖ Configura√ß√£o salva! Carregando dados...', 'success');
            setTimeout(loadData, 1000);
        }
        
        function showError(message, type = 'error') {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => container.innerHTML = '', 3000);
            }
        }
        
        async function querySupabase(sql) {
            const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`
                },
                body: JSON.stringify({ query: sql })
            });
            
            if (!response.ok) {
                // Fallback: tentar query direta
                return querySupabaseDirect(sql);
            }
            
            return response.json();
        }
        
        async function querySupabaseDirect(table, params = {}) {
            const url = new URL(`${supabaseUrl}/rest/v1/${table}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            const response = await fetch(url, {
                headers: {
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`
                }
            });
            
            if (!response.ok) throw new Error('Erro ao consultar Supabase');
            return response.json();
        }
        
        async function loadData() {
            if (!supabaseUrl || !supabaseKey) {
                showError('Configure o Supabase primeiro');
                return;
            }
            
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Carregando...';
            
            try {
                // Carregar estat√≠sticas
                await loadStats();
                
                // Carregar gr√°ficos
                await loadCharts();
                
                // Carregar alertas
                await loadAlerts();
                
                document.getElementById('lastUpdate').textContent = 
                    `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`;
                
                showError('');
            } catch (error) {
                console.error('Erro:', error);
                showError(`Erro ao carregar dados: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Atualizar';
            }
        }
        
        async function loadStats() {
            // Total de conversas (√∫ltimos 30 dias)
            const conversas = await querySupabaseDirect('pf_messages', {
                select: 'id',
                created_at: `gte.${new Date(Date.now() - 30*24*60*60*1000).toISOString()}`
            });
            document.getElementById('totalConversas').textContent = conversas.length;
            
            // Gargalos detectados
            const gargalos = await querySupabaseDirect('pf_gargalos', {
                select: 'id,has_gargalo,risk_level',
                has_gargalo: 'eq.true'
            });
            document.getElementById('totalGargalos').textContent = gargalos.length;
            
            // Taxa de gargalos
            const taxa = conversas.length > 0 ? 
                ((gargalos.length / conversas.length) * 100).toFixed(1) : 0;
            document.getElementById('taxaGargalos').textContent = `${taxa}%`;
            
            // Alertas cr√≠ticos
            const criticos = gargalos.filter(g => g.risk_level === 'ALTO').length;
            document.getElementById('alertasCriticos').textContent = criticos;
        }
        
        async function loadCharts() {
            // Gr√°fico de tipos de gargalos
            const gargalos = await querySupabaseDirect('pf_gargalos', {
                select: 'gargalo_type',
                has_gargalo: 'eq.true'
            });
            
            const tipos = {};
            gargalos.forEach(g => {
                tipos[g.gargalo_type] = (tipos[g.gargalo_type] || 0) + 1;
            });
            
            createGargalosChart(tipos);
            
            // Gr√°fico de evolu√ß√£o (√∫ltimos 14 dias)
            const messages = await querySupabaseDirect('pf_messages', {
                select: 'created_at',
                created_at: `gte.${new Date(Date.now() - 14*24*60*60*1000).toISOString()}`,
                order: 'created_at.asc'
            });
            
            const gargalosDiarios = await querySupabaseDirect('pf_gargalos', {
                select: 'created_at,has_gargalo',
                created_at: `gte.${new Date(Date.now() - 14*24*60*60*1000).toISOString()}`,
                has_gargalo: 'eq.true',
                order: 'created_at.asc'
            });
            
            createEvolucaoChart(messages, gargalosDiarios);
            
            // Gr√°fico de vendedores
            const vendedores = await querySupabaseDirect('pf_gargalos', {
                select: 'vendedor,has_gargalo,thread_id'
            });
            
            createVendedoresChart(vendedores);
        }
        
        function createGargalosChart(tipos) {
            const ctx = document.getElementById('gargalosChart').getContext('2d');
            
            if (gargalosChart) gargalosChart.destroy();
            
            const cores = {
                'PRECO_VALOR': '#e74c3c',
                'PARCELAMENTO': '#f39c12',
                'FRETE': '#3498db',
                'BOLETO': '#9b59b6'
            };
            
            gargalosChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        data: Object.values(tipos),
                        backgroundColor: Object.keys(tipos).map(t => cores[t] || '#95a5a6'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }
        
        function createEvolucaoChart(messages, gargalos) {
            const ctx = document.getElementById('evolucaoChart').getContext('2d');
            
            if (evolucaoChart) evolucaoChart.destroy();
            
            // Agrupar por dia
            const dadosPorDia = {};
            
            messages.forEach(m => {
                const dia = new Date(m.created_at).toLocaleDateString('pt-BR');
                dadosPorDia[dia] = dadosPorDia[dia] || { conversas: 0, gargalos: 0 };
                dadosPorDia[dia].conversas++;
            });
            
            gargalos.forEach(g => {
                const dia = new Date(g.created_at).toLocaleDateString('pt-BR');
                if (dadosPorDia[dia]) {
                    dadosPorDia[dia].gargalos++;
                }
            });
            
            const labels = Object.keys(dadosPorDia).slice(-14);
            const datasConversas = labels.map(l => dadosPorDia[l].conversas);
            const datasGargalos = labels.map(l => dadosPorDia[l].gargalos);
            
            evolucaoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gargalos',
                            data: datasGargalos,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Conversas',
                            data: datasConversas,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createVendedoresChart(dados) {
            const ctx = document.getElementById('vendedoresChart').getContext('2d');
            
            if (vendedoresChart) vendedoresChart.destroy();
            
            const stats = {};
            dados.forEach(d => {
                if (!stats[d.vendedor]) {
                    stats[d.vendedor] = { leads: new Set(), gargalos: 0 };
                }
                stats[d.vendedor].leads.add(d.thread_id);
                if (d.has_gargalo) {
                    stats[d.vendedor].gargalos++;
                }
            });
            
            const vendedores = Object.keys(stats);
            const leads = vendedores.map(v => stats[v].leads.size);
            const gargalos = vendedores.map(v => stats[v].gargalos);
            
            vendedoresChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vendedores,
                    datasets: [
                        {
                            label: 'Leads Atendidos',
                            data: leads,
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'Gargalos Detectados',
                            data: gargalos,
                            backgroundColor: '#e74c3c'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        async function loadAlerts() {
            const alertas = await querySupabaseDirect('pf_gargalos', {
                select: 'lead_name,vendedor,gargalo_type,risk_level,why,created_at',
                has_gargalo: 'eq.true',
                risk_level: 'in.(ALTO,MEDIO)',
                order: 'created_at.desc',
                limit: '20'
            });
            
            const container = document.getElementById('alertsList');
            
            if (alertas.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">Nenhum alerta cr√≠tico no momento üéâ</p>';
                return;
            }
            
            container.innerHTML = alertas.map(lead => `
                <div class="alert-item ${lead.risk_level}">
                    <div class="alert-header">
                        <span class="alert-name">üë§ ${lead.lead_name}</span>
                        <span class="alert-badge ${lead.risk_level}">${lead.risk_level}</span>
                    </div>
                    <div class="alert-details">
                        <strong>Tipo:</strong> ${lead.gargalo_type} | 
                        <strong>Vendedor:</strong> ${lead.vendedor} | 
                        <strong>Hor√°rio:</strong> ${new Date(lead.created_at).toLocaleString('pt-BR')}
                    </div>
                    <div class="alert-details" style="margin-top: 8px;">
                        üí¨ ${lead.why || 'Sem detalhes'}
                    </div>
                </div>
            `).join('');
        }
        
        // Auto-refresh a cada 5 minutos
        setInterval(() => {
            if (supabaseUrl && supabaseKey) {
                loadData();
            }
        }, 300000);
    </script>
</body>
</html>
